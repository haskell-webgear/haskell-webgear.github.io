
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="WebGear is a library to build composable, type-safe HTTP APIs in Haskell.">
      
      
        <meta name="author" content="Raghu Kaippully">
      
      
        <link rel="canonical" href="https://haskell-webgear.github.io/1.4/tutorial/request-handling/handlers-and-middlewares/">
      
      
        <link rel="prev" href="../routing/">
      
      
        <link rel="next" href="../request-traits/">
      
      
      <link rel="icon" href="../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4">
    
    
      
        <title>Handlers and Middlewares - WebGear</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 13v-2h8l-3.5-3.5 1.42-1.42L17.84 12l-5.92 5.92-1.42-1.42L14 13zm16-1a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-2 0a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/fontawesome.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#handlers-and-middlewares" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="WebGear" class="md-header__button md-logo" aria-label="WebGear" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WebGear
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Handlers and Middlewares
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/haskell-webgear/webgear" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../first-steps/introduction/" class="md-tabs__link">
          
  
  Tutorial

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../packages/" class="md-tabs__link">
        
  
    
  
  Packages

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="WebGear" class="md-nav__button md-logo" aria-label="WebGear" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    WebGear
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/haskell-webgear/webgear" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    First Steps
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            First Steps
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../first-steps/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../first-steps/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Request Handling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Request Handling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../routing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Routing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Handlers and Middlewares
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Handlers and Middlewares
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#request-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Request Handlers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middlewares" class="md-nav__link">
    <span class="md-ellipsis">
      Middlewares
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traits" class="md-nav__link">
    <span class="md-ellipsis">
      Traits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-better-type-signature" class="md-nav__link">
    <span class="md-ellipsis">
      A Better Type Signature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monadic-actions-in-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Monadic Actions in Handlers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bring-your-own-monad" class="md-nav__link">
    <span class="md-ellipsis">
      Bring Your Own Monad
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../request-traits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Request Traits
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generating-responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generating Responses
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Advanced
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Advanced
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/arrows-primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Arrows Primer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/traits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Traits
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../packages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Packages
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="handlers-and-middlewares">Handlers and Middlewares</h1>
<p>Now that you've learned how routing works, it is time to learn about request handlers.</p>
<p>A typical web application will extract some data from the request, do some processing, and then produce a
response. WebGear request handlers help to implement all these three steps in a convenient, type-safe manner. Let us see
how.</p>
<h2 id="request-handlers">Request Handlers</h2>
<p>A request handler is an arrow that takes a request as input and produces a response as output. You already saw a few
handlers in this tutorial. They have a few properties that you should learn to use WebGear effectively.</p>
<p>Request handlers represent an abstract computation that can derive a response based on a request. This abstract
computation can be converted to a concrete web application by passing it to the <code class="language-hs highlight"><span class="nf">toApplication</span></code> function. You
already saw the usage of <code class="language-hs highlight"><span class="nf">toApplication</span></code> in previous chapters, but we never mentioned that its argument is a
handler.</p>
<p>Request handlers are composable. In the <a href="../routing/#multiple-endpoints">routing</a> chapter, you saw that multiple
endpoints can be combined with the <code class="language-hs highlight"><span class="o">&lt;+&gt;</span></code> operator to produce a single handler.</p>
<h2 id="middlewares">Middlewares</h2>
<p>A middleware is a function that takes a handler as input and produces another handler as output. You've encountered a
few middlewares already even though they weren't explicitly labelled so. The <code class="language-hs highlight"><span class="nf">method</span></code>, <code class="language-hs highlight"><span class="nf">path</span></code>, <code class="language-hs highlight"><span class="nf">pathVar</span></code>,
and <code class="language-hs highlight"><span class="nf">pathEnd</span></code> functions from the <a href="../routing/">routing</a> are examples of middlewares. They accept a handler as
input and invokes it only if some criteria is met.</p>
<p>Since middlewares return a handler, we can chain them together and produce a handler as shown in the example below:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">method</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="kt">GET</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s">&quot;/api/user&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathVar</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="o">@</span><span class="kt">Int</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathEnd</span><span class="w"> </span><span class="n">userHandler</span>
</span></code></pre></div>
<h2 id="traits">Traits</h2>
<p>WebGear has many more middlewares, we'll explore them in the next chapter. For now, let us turn our attention to the
<code class="language-hs highlight"><span class="nf">pathVar</span></code> middleware. In the code above, <code class="language-hs highlight"><span class="nf">pathVar</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="o">@</span><span class="kt">Int</span></code> extracts a path variable of type <code class="language-hs highlight"><span class="kt">Int</span></code>. How can we use this variable in our handler?</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nf">method</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="kt">GET</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s">&quot;/api/user&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathVar</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="o">@</span><span class="kt">Int</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathEnd</span><span class="w"> </span><span class="o">$</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="n">userId</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">pick</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">request</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="n">respondA</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="n">ok200</span><span class="w"> </span><span class="kt">PlainText</span><span class="w"> </span><span class="o">-&lt;</span><span class="w"> </span><span class="s">&quot;ID = &quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">userId</span>
</span></code></pre></div>
<p>You just <em>pick</em> the value from the request. But how do we know that the request contains such a path variable? After
all, the request can contain a completely different path. Note that the type of <code class="language-hs highlight"><span class="nf">userId</span></code> is <code class="language-hs highlight"><span class="kt">Int</span></code>. Shouldn't
it be <code class="language-hs highlight"><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Int</span></code> to accommodate the case where the request does not have the path variable?</p>
<p>Let us experiment a little bit; what if you remove the <code class="language-hs highlight"><span class="nf">pathVar</span></code> middleware from the code?</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nf">method</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="kt">GET</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s">&quot;/api/user&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathEnd</span><span class="w"> </span><span class="o">$</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">        </span><span class="n">userId</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">pick</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">request</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">respondA</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="n">ok200</span><span class="w"> </span><span class="kt">PlainText</span><span class="w"> </span><span class="o">-&lt;</span><span class="w"> </span><span class="s">&quot;ID = &quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">userId</span>
</span></code></pre></div>
<p>Try compiling this code and you'll get an error:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>• The value doesn&#39;t have the ‘PathVar &quot;userId&quot; Int’ trait.
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>  Did you forget to apply an appropriate middleware?
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  ...
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>  or did you use a wrong trait type?
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>  ...
</span></code></pre></div>
<p>That's very impressive. WebGear stops us from using an attribute that could be missing from the request. We can't pick
the path variable from the request unless we have used the appropriate middleware. How does that work? What is this
<em>trait</em> mentioned in the error message?</p>
<p>It'll be clearer if we add a type signature to the handler:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nf">myApp</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Wai</span><span class="o">.</span><span class="kt">Application</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nf">myApp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">toApplication</span><span class="w"> </span><span class="o">$</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="n">method</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="kt">GET</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s">&quot;/api/user&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathVar</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="o">@</span><span class="kt">Int</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">pathEnd</span><span class="w"> </span><span class="n">userHandler</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nf">userHandler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">HasTrait</span><span class="w"> </span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="p">(</span><span class="kt">Request</span><span class="w"> </span><span class="p">`</span><span class="kt">With</span><span class="p">`</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="kt">Response</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="nf">userHandler</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">      </span><span class="n">userId</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">pick</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">request</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">  </span><span class="n">respondA</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="n">ok200</span><span class="w"> </span><span class="kt">PlainText</span><span class="w"> </span><span class="o">-&lt;</span><span class="w"> </span><span class="s">&quot;ID = &quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">userId</span>
</span></code></pre></div>
<p>The type of <code class="language-hs highlight"><span class="nf">userHandler</span></code> is <code class="language-hs highlight"><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="p">(</span><span class="kt">Request</span></code>With<code>ts) Response</code>. Here, <code>ServerHandler IO</code> is the
type of the arrow used as the handler. The arrow input is <code class="language-hs highlight"><span class="kt">Request</span><span class="w"> </span><span class="p">`</span><span class="kt">With</span><span class="p">`</span><span class="w"> </span><span class="n">ts</span></code> and the output is <code class="language-hs highlight"><span class="kt">Response</span></code>.</p>
<p>In this type, <code class="language-hs highlight"><span class="nf">ts</span></code> is a list of trait types. You might be wondering, what is a trait? Simply put, traits are
attributes associated with a request. <code class="language-hs highlight"><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span></code> is one such trait that represents a path variable. The
<code class="language-hs highlight"><span class="nf">ts</span></code> type variable contains all traits that are known to be present in the request. The <code class="language-hs highlight"><span class="kt">HasTrait</span><span class="w"> </span><span class="p">(</span><span class="kt">PathVar</span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="n">ts</span></code> constraint is an assertion that the path variable trait definitely exists in the list <code class="language-hs highlight"><span class="nf">ts</span></code>. That
is why we can use <code class="language-hs highlight"><span class="nf">pick</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span></code> to get a user ID without having to handle the case of a missing
path variable.</p>
<p>In order to satisfy the <code class="language-hs highlight"><span class="kt">HasTrait</span></code> constraint, we must use the <code class="language-hs highlight"><span class="nf">pathVar</span></code> middleware. If you omit that
middleware, the constraint will not be satisfied and GHC will show an error message as shown above.</p>
<p>In the rest of this tutorial, you will see this pattern used again and again. Your handler will be wrapped in an
appropriate middleware and then the handler can access trait using the <code class="language-hs highlight"><span class="nf">pick</span></code> function.</p>
<h2 id="a-better-type-signature">A Better Type Signature</h2>
<p>The type signature of <code>userHandler</code> given above works fine. However, WebGear handlers tend to use a more general type:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nf">userHandler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">StdHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">HasTrait</span><span class="w"> </span><span class="p">(</span><span class="kt">PathVar</span><span class="w"> </span><span class="s">&quot;userId&quot;</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">RequestHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">ts</span>
</span></code></pre></div>
<p><code class="language-hs highlight"><span class="kt">RequestHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">ts</span></code> is a type synonym and is equivalent to <code class="language-hs highlight"><span class="nf">h</span><span class="w"> </span><span class="p">(</span><span class="kt">Request</span><span class="w"> </span><span class="p">`</span><span class="kt">With</span><span class="p">`</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="kt">Response</span></code>. Doesn't that
look very similar to <code class="language-hs highlight"><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="p">(</span><span class="kt">Request</span><span class="w"> </span><span class="p">`</span><span class="kt">With</span><span class="p">`</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="kt">Response</span></code>? Of course, it does. The main change we did
is to replace <code class="language-hs highlight"><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span></code> with a type variable <code class="language-hs highlight"><span class="nf">h</span></code>.</p>
<p>As mentioned above, <code class="language-hs highlight"><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span></code> is the type of the arrow used by <code class="language-hs highlight"><span class="nf">userHandler</span></code>. This arrow allows us to
convert the handler to a Wai application using the <code class="language-hs highlight"><span class="nf">toApplication</span></code> function. But WebGear handlers are not limited
to just being an application. In a later chapter, you'll learn how to generate OpenAPI or Swagger documentation from
these handlers. In order to support all such use cases, we switch to a polymorphic type variable <code class="language-hs highlight"><span class="nf">h</span></code> instead of the
concrete arrow type <code class="language-hs highlight"><span class="kt">ServerHandler</span><span class="w"> </span><span class="kt">IO</span></code>. WebGear can substitute an appropriate type in place of <code class="language-hs highlight"><span class="nf">h</span></code> depending
on the use case.</p>
<p>As a result of this change, we need an additional constraint <code class="language-hs highlight"><span class="kt">StdHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">m</span></code> in the type signature. This
constraint enforces that <code class="language-hs highlight"><span class="nf">h</span></code> is a handler arrow and has capabilities that all WebGear handlers are required to
have. For example, handler arrows can embed monadic actions in them. We'll see more on that in the next section.</p>
<p>Going forward, we will use this polymorphic type signature for all our handlers.</p>
<h2 id="monadic-actions-in-handlers">Monadic Actions in Handlers</h2>
<p>Most WebGear handlers will need some monadic actions to process the request. As an example, let us consider a handler
that returns the current date and time in UTC. We can use the <code class="language-hs highlight"><span class="kt">Data</span><span class="o">.</span><span class="kt">Time</span><span class="o">.</span><span class="n">getCurrentTime</span></code> function for this
pupose. But, that function has the type <code class="language-hs highlight"><span class="kt">IO</span><span class="w"> </span><span class="kt">UTCTime</span></code>. How do we add it to a handler which is an arrow and not a
monad?</p>
<p>It is fairly straightforward. All handlers allow embedding monadic actions in them using a function <code class="language-hs highlight"><span class="nf">arrM</span></code>. This is
how you'd use it:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kr">import</span><span class="w"> </span><span class="nn">Data.Time</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kr">import</span><span class="w"> </span><span class="nn">Control.Monad.IO.Class</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nf">currentTimeHandler</span><span class="w"> </span><span class="ow">::</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="n">forall</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">ts</span><span class="o">.</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">(</span><span class="kt">StdHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">MonadIO</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="kt">RequestHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">ts</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nf">currentTimeHandler</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">  </span><span class="n">now</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">arrM</span><span class="w"> </span><span class="n">getNow</span><span class="w"> </span><span class="o">-&lt;</span><span class="w"> </span><span class="nb">()</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">  </span><span class="n">respondA</span><span class="w"> </span><span class="kt">HTTP</span><span class="o">.</span><span class="n">ok200</span><span class="w"> </span><span class="kt">PlainText</span><span class="w"> </span><span class="o">-&lt;</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">now</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">  </span><span class="kr">where</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="n">getNow</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="kt">UTCTime</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="n">getNow</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">liftIO</span><span class="w"> </span><span class="n">getCurrentTime</span>
</span></code></pre></div>
<p>If you have a function of type <code class="language-hs highlight"><span class="nf">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span></code> where <code class="language-hs highlight"><span class="nf">m</span></code> is a monad, the function <code class="language-hs highlight"><span class="nf">arrM</span></code> can <em>lift</em> it to a
handler arrow of type <code class="language-hs highlight"><span class="kt">StdHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span></code>. In the above example, we lifted the <code class="language-hs highlight"><span class="nf">getNow</span></code> function to an
arrow of type <code class="language-hs highlight"><span class="nf">h</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="kt">UTCTime</span></code> and used it inside the <code class="language-hs highlight"><span class="nf">proc</span></code> body.</p>
<p>Unlike monads, handlers (and arrows in general) require both an input and an output. The <code class="language-hs highlight"><span class="nf">getCurrentTime</span></code> IO action
does not require any inputs and we should convert it to a function by passing <code class="language-hs highlight"><span class="nb">()</span></code> as an input.</p>
<h2 id="bring-your-own-monad">Bring Your Own Monad</h2>
<p>Notice how we used the <code class="language-hs highlight"><span class="kt">MonadIO</span><span class="w"> </span><span class="n">m</span></code> constraint instead of using the concrete <code class="language-hs highlight"><span class="kt">IO</span></code> type. Using a polymorphic
type helps us to switch to a different monad if required without modifying the handler.</p>
<p>You may use any monad of your choice with request handlers. However, the <code class="language-hs highlight"><span class="nf">toApplication</span></code> function requires the
handler to be based on the <code>#hs IO</code> monad. So, how do you convert handlers based on your custom monad stack to a Wai
application?</p>
<p>The answer is to use the <code class="language-hs highlight"><span class="nf">transform</span></code> function to convert your monad stack. Let us assume you have a <a href="https://tech.fpcomplete.com/blog/2017/06/readert-design-pattern/">ReaderT
stack</a>. This is how you generate a Wai application in
that case:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nf">apiHandler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">StdHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="p">(</span><span class="kt">ReaderT</span><span class="w"> </span><span class="kt">Env</span><span class="w"> </span><span class="kt">IO</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">RequestHandler</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">ts</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nf">apiHandler</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="o">...</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nf">application</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Wai</span><span class="o">.</span><span class="kt">Application</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="nf">application</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">toApplication</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">transform</span><span class="w"> </span><span class="n">appToIO</span><span class="w"> </span><span class="n">apiHandler</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="kr">where</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">appToIO</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">ReaderT</span><span class="w"> </span><span class="kt">Env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="n">appToIO</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runReaderT</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">env</span>
</span></code></pre></div>
<p>The <code class="language-hs highlight"><span class="nf">transform</span></code> function has the following type:</p>
<div class="language-haskell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nf">transform</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">forall</span><span class="w"> </span><span class="n">x</span><span class="o">.</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">ServerHandler</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">ServerHandler</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span>
</span></code></pre></div>
<p>Given a function - such as <code class="language-hs highlight"><span class="nf">appToIO</span></code> above - that transforms one monadic action to another, it can transform
between the corresponding <code class="language-hs highlight"><span class="kt">ServerHandler</span></code> types. You then pass the transformed handler to <code class="language-hs highlight"><span class="nf">toApplication</span></code>.</p>
<h2 id="summary">Summary</h2>
<p>In this chapter, you learned the basics of request handlers, middlewares, and traits. By now, you have a good
understanding of how traits help in accessing request attributes in a type safe manner. You also learned to write
polymorphic type signatures for request handlers.</p>
<p>In the next chapter we'll meet many more commonly used middlewares and traits.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../routing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Routing">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Routing
              </div>
            </div>
          </a>
        
        
          
          <a href="../request-traits/" class="md-footer__link md-footer__link--next" aria-label="Next: Request Traits">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Request Traits
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2025 Raghu Kaippully
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "navigation.footer", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/js/fontawesome.min.js"></script>
      
    
  </body>
</html>